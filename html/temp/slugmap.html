<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1ucO9jQXDgG9YoVeehqD9qmgTTyL2nt4&callback=initMap">
    </script>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

var delay = 2000; // 2 second delay
var loopBusCount = 0;
var loopBusCountInitial = 0;
var listOfLoopBusMarkers = [];

  // http://stackoverflow.com/questions/30938021/continuously-updating-google-maps-with-user-location
  // call the function initally
function updatePosition(map, myLatLng) {
    $.ajax({
        url: "http://bts.ucsc.edu:8081/location/get",
        dataType: 'json'
    })
    .done(function callDone(data) {
        // update marker position
        for (var i = 0; i < data.length; i++) { 
          loopBusCount = loopBusCount +1;
        }

        //set the intial markers if the list of markers is empty
        if(listOfLoopBusMarkers.length == 0){
          for (var i = 0; i < loopBusCount; i++) {
            var loopMarker = new google.maps.Marker({
              map: map,
              position: myLatLng,
              title: 'Hello World!'
            });
            listOfLoopBusMarkers[i] = loopMarker;
            listOfLoopBusMarkers[i].setMap(map);
          }
          loopBusCountInitial = loopBusCount;
        }

        //if the number of loop buses increase then add on markers
        if(loopBusCount > loopBusCountInitial){
          var numOfNewLoopBusCount = loopBusCount - loopBusCountInitial;
          for(var i=0;i<numOfNewLoopBusCount;i++){
            var loopMarker = new google.maps.Marker({
              map: map,
              position: myLatLng,
              title: 'Hello World!'
            });
            listOfLoopBusMarkers.push(loopMarker);
            listOfLoopBusMarkers[listOfLoopBusMarkers.length-1].setMap(map);            
          }
          loopBusCountInitial = loopBusCount
        }
        //else if the number of loop buses decrease clear the markers and reload the amount of loop bus markers
        else if(loopBusCount < loopBusCountInitial){
          listOfLoopBusMarkers = []
          setTimeout( updatePosition(map, myLatLng), delay );
        }
        // if the same number of loop buses are recieved from the previous state then don't add or delete markers
        else{
        }

        // update marker position
        for (var i = 0; i < data.length; i++) { 
          var latLng = new google.maps.LatLng( data[i].lat, data[i].lon );
          listOfLoopBusMarkers[i].setPosition( latLng );
        }

        // call the function again
        setTimeout( updatePosition(map, myLatLng), delay );
    });
}


function initMap() {
  // Create a map object and specify the DOM element for display.
  var myLatLng = {lat: 0, lng: 0};
  var map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 37.0000, lng: -122.0600},
              scrollwheel: false,
              zoom: 16

            });
  updatePosition(map, myLatLng);
}

    </script>

  </body>
</html>