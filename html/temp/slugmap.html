<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1ucO9jQXDgG9YoVeehqD9qmgTTyL2nt4&callback=initMap">
    </script>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

var delay = 2000; // 2 second delay
var map;
var listOfLoopBusMarkers = [];
var loopBusCount = 0;



  // http://stackoverflow.com/questions/30938021/continuously-updating-google-maps-with-user-location
  // call the function initally
function updatePosition() {
    $.ajax({
        url: "http://bts.ucsc.edu:8081/location/get",
        dataType: 'json'
    })
    .done(function callDone(data) {
        // update marker position
        for (i = 0; i < data.length; i++) { 
          var latLng = new google.maps.LatLng( data[i].lat, data[i].lon );
          listOfLoopBusMarkers[i].setPosition( latLng );
        }

        // call the function again

        setTimeout( updatePosition, delay );
    });
}

function countLoop() {
    $.ajax({
        url: "http://bts.ucsc.edu:8081/location/get",
        dataType: 'json'
    })
    .done(function callDone(data) {
        // update marker position
        for (i = 0; i < data.length; i++) { 
          loopBusCount = loopBusCount +1;
        }
        var str1 = "There are currently "
        var str2 = loopBusCount
        var str3 = " loop buses running."
        alert(str1.concat(str2,str3));
        var myLatLng = {lat: 37.0000, lng: -122.0600};
        for (i = 0; i < loopBusCount; i++) {

          var loopMarker = new google.maps.Marker({
            map: map,
            position: myLatLng,
            title: 'Hello World!'
          });
          listOfLoopBusMarkers[i] = loopMarker;
        }
        // Create a map object and specify the DOM element for display.
        map = new google.maps.Map(document.getElementById('map'), {
          center: myLatLng,
          scrollwheel: false,
          zoom: 16
        });

        for (i = 0; i < loopBusCount; i++) {
          listOfLoopBusMarkers[i].setMap(map);
        }




      setTimeout( updatePosition, delay );

    });
}


function initMap() {
    countLoop();
}

    </script>

  </body>
</html>